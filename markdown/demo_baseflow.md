demo\_baseflow.R
================
Dean Koch
2021-06-08

**Mitacs UYRW project**

**demo\_baseflow.R**: (in development) the SWAT+ process model for baseflow

## introduction

The model for groundwater in SWAT+ conceptualizes the "shallow aquifer" as a constant depth reservoir
which receives water via percolation from the lowest soil layer and drains, with a fixed delay period,
into channels. A small fraction of percolation is redirected to the "deep aquifer", and that water is
effectively lost from the system (ie it never makes its way into channels). Another fraction is redirected
back upwards to the soil to account for evaporation and root uptake. All of these processes have threshold
water storage values below which no flow occurs, and all parameters are spatially uniform within an HRU.

The script below includes a description of the relevant parameters for groundwater
movement and, and notes on calibrating `aquifer.aqu` and related files
in SWAT+

This script uses for demonstration the SWAT+ model generated in
[demo\_qswat](https://github.com/deankoch/UYRW_data/blob/master/markdown/demo_qswat.md)
(and modified by
[demo\_txtinout](https://github.com/deankoch/UYRW_data/blob/master/markdown/demo_qswat.md),
where most of the `rswat_*` functions are introduced). It also makes
extensive use of the
[`rswat_docs`](https://github.com/deankoch/UYRW_data/blob/master/markdown/rswat_docs.md)
function, which parses the SWAT+ inputs documentation for easier
searching. Note that you must download the file documentation PDF
“inputs\_swatplus\_rev60\_5.pdf” [from
here](https://swatplus.gitbook.io/docs/user/io) for `rswat_docs` to
work.

## libraries

[helper\_main](https://github.com/deankoch/UYRW_data/blob/master/markdown/helper_main.md)
and
[rswat](https://github.com/deankoch/UYRW_data/blob/master/markdown/rswat.md)
load required libraries, global variables, and some helper functions.

``` r
library(here)
source(here('R/helper_main.R'))
#source(here('R/analysis/helper_analysis.R'))
source(here('R/rswat.R'))
```

    ## Warning: package 'pdftools' was built under R version 4.0.5

    ## Using poppler version 21.04.0

## project data

load the SWAT+ project info and gage data from previous scripts

``` r
# load some info about the SWAT+ model
qswat.meta = my_metadata('demo_qswat', data.dir=demo.subdir)
txtinout.meta = my_metadata('demo_txtinout', data.dir=demo.subdir)
nm = qswat.meta['example_name', 'file']
print(nm)
```

    ## [1] "big_c_nr_emigrant"

``` r
# load the gage data for this catchment 
gage = readRDS(here(qswat.meta['gage', 'file']))
head(gage)
```

    ##         date             flow
    ## 1 1973-09-01 1.302575 [m^3/s]
    ## 2 1973-09-02 1.160991 [m^3/s]
    ## 3 1973-09-03 1.132674 [m^3/s]
    ## 4 1973-09-04 1.076040 [m^3/s]
    ## 5 1973-09-05 1.019406 [m^3/s]
    ## 6 1973-09-06 1.019406 [m^3/s]

``` r
# grab directory of the project folder and its backup
demo.dir = here( txtinout.meta['txtinout', 'file'] )
demobak.dir = here( txtinout.meta['txtinout_bak', 'file'] )

# load the SWAT+ documentation
rswat_pdf_open('D:/UYRW_data/development/inputs_swatplus_rev60_5.pdf', quiet=TRUE)
```

    ## done

## define script outputs

    ## [1] "> writing metadata to: data/demo_baseflow_metadata.csv"

This script generates a number of (.png) figures. Load the list of
output files and descriptions from a [CSV
file](https://github.com/deankoch/UYRW_data/blob/master/data/demo_baseflow_metadata.csv)
(generated from code hidden above)

``` r
# load metadata CSV
baseflow.meta = my_metadata('demo_baseflow')
tibble(baseflow.meta)
```

    ## # A tibble: 9 x 3
    ##   file                                          type       description                                          
    ##   <chr>                                         <chr>      <chr>                                                
    ## 1 graphics/demo_baseflow                        directory  "directory for graphics generated by the demo_basefl~
    ## 2 graphics/demo_baseflow/initial_big_c_nr_emig~ PNG graph~ "hydrograph of USGS discharge at the demo catchment" 
    ## 3 graphics/demo_baseflow/alpha_bf_big_c_nr_emi~ PNG graph~ "SWAT+ hydrograph showing a range of \"alpha_bf\" va~
    ## 4 graphics/demo_baseflow/dep_wt_big_c_nr_emigr~ PNG graph~ "SWAT+ hydrograph showing a range of \"dep_wt\" valu~
    ## 5 graphics/demo_baseflow/flo_min_big_c_nr_emig~ PNG graph~ "SWAT+ hydrograph showing a range of \"flo_min\" val~
    ## 6 graphics/demo_baseflow/rchg_dp_big_c_nr_emig~ PNG graph~ "SWAT+ hydrograph showing a range of \"rchg_dp\" val~
    ## 7 graphics/demo_baseflow/revap_big_c_nr_emigra~ PNG graph~ "SWAT+ hydrograph showing a range of \"revap\" value~
    ## 8 graphics/demo_baseflow/revap_min_big_c_nr_em~ PNG graph~ "SWAT+ hydrograph showing a range of \"revap_min\" v~
    ## 9 data/demo_baseflow_metadata.csv               CSV        "list of files written by demo_baseflow.R"

``` r
# create the graphics subdirectory if it doesn't exist already and set plot size in inches
my_dir(here(baseflow.meta['graphics', 'file']))
plot.w = 8
plot.h = 3
```

## load/prepare a SWAT+ project

Start by loading a SWAT+ project folder

``` r
# point `rswat` to the demo "TxtInOut" directory used earlier 
demo.dir = here( txtinout.meta['txtinout', 'file'] )
print(demo.dir)
```

    ## [1] "D:/UYRW_data/data/demo/demo_big_c_nr_emigrant_txtinout"

``` r
rswat_cio(demo.dir)
```

    ## setting `ciopath` to D:/UYRW_data/data/demo/demo_big_c_nr_emigrant_txtinout/file.cio 
    ## file.cio: written by SWAT+ editor v2.0.0 on 2021-05-28 15:49

    ##                 file          group                size            modified
    ## 1           time.sim     simulation   0.168 [kilobytes] 2021-06-08 15:17:46
    ## 2          print.prt     simulation   3.389 [kilobytes] 2021-06-08 15:17:46
    ## 3         object.prt     simulation   0.155 [kilobytes] 2021-06-08 15:17:46
    ## 4         object.cnt     simulation   0.577 [kilobytes] 2021-06-08 15:11:58
    ## 5          codes.bsn          basin   0.599 [kilobytes] 2021-06-08 15:11:55
    ## 6     parameters.bsn          basin   1.296 [kilobytes] 2021-06-08 15:11:58
    ## 7    weather-sta.cli        climate   3.622 [kilobytes] 2021-06-08 15:11:58
    ## 8    weather-wgn.cli        climate  42.549 [kilobytes] 2021-06-08 15:11:58
    ## 9            pcp.cli        climate   0.359 [kilobytes] 2021-06-08 15:11:58
    ## 10           tmp.cli        climate   0.357 [kilobytes] 2021-06-08 15:11:58
    ## 11           hmd.cli        climate   0.363 [kilobytes] 2021-06-08 15:11:56
    ## 12           wnd.cli        climate   0.356 [kilobytes] 2021-06-08 15:11:58
    ## 13           hru.con        connect   8.425 [kilobytes] 2021-06-08 15:11:56
    ## 14     rout_unit.con        connect  16.283 [kilobytes] 2021-06-08 15:11:58
    ## 15       aquifer.con        connect  13.793 [kilobytes] 2021-06-08 15:11:55
    ## 16        recall.con        connect   5.680 [kilobytes] 2021-06-08 15:11:58
    ## 17       chandeg.con        connect   5.629 [kilobytes] 2021-06-08 15:11:55
    ## 18       initial.cha        channel   0.321 [kilobytes] 2021-06-08 15:11:57
    ## 19     nutrients.cha        channel   1.166 [kilobytes] 2021-06-08 15:11:58
    ## 20   channel-lte.cha        channel   2.721 [kilobytes] 2021-06-08 15:11:55
    ## 21   hyd-sed-lte.cha        channel   8.712 [kilobytes] 2021-06-08 15:11:56
    ## 22     rout_unit.def   routing_unit   2.617 [kilobytes] 2021-06-08 15:11:58
    ## 23     rout_unit.ele   routing_unit   4.453 [kilobytes] 2021-06-08 15:11:58
    ## 24     rout_unit.rtu   routing_unit   5.269 [kilobytes] 2021-06-08 15:11:58
    ## 25      hru-data.hru            hru   8.940 [kilobytes] 2021-06-08 15:11:56
    ## 26          exco.exc           exco   2.922 [kilobytes] 2021-06-08 15:11:55
    ## 27       exco_om.exc           exco   7.137 [kilobytes] 2021-06-08 15:11:55
    ## 28        recall.rec         recall   1.572 [kilobytes] 2021-06-08 15:11:58
    ## 29       initial.aqu        aquifer   0.321 [kilobytes] 2021-06-08 15:11:57
    ## 30       aquifer.aqu        aquifer  13.481 [kilobytes] 2021-06-08 15:17:46
    ## 31     hydrology.hyd      hydrology  11.083 [kilobytes] 2021-06-08 15:11:57
    ## 32    topography.hyd      hydrology   9.158 [kilobytes] 2021-06-08 15:11:58
    ## 33         field.fld      hydrology   3.225 [kilobytes] 2021-06-08 15:11:56
    ## 34     tiledrain.str     structural   0.331 [kilobytes] 2021-06-08 15:11:58
    ## 35        septic.str     structural   1.211 [kilobytes] 2021-06-08 15:11:58
    ## 36   filterstrip.str     structural   0.341 [kilobytes] 2021-06-08 15:11:56
    ## 37     grassedww.str     structural   0.560 [kilobytes] 2021-06-08 15:11:56
    ## 38       bmpuser.str     structural   0.304 [kilobytes] 2021-06-08 15:11:55
    ## 39        plants.plt    hru_parm_db 194.373 [kilobytes] 2021-06-08 15:11:58
    ## 40    fertilizer.frt    hru_parm_db   7.216 [kilobytes] 2021-06-08 15:11:55
    ## 41       tillage.til    hru_parm_db   8.311 [kilobytes] 2021-06-08 15:11:58
    ## 42     pesticide.pes    hru_parm_db  49.945 [kilobytes] 2021-06-08 15:11:58
    ## 43         urban.urb    hru_parm_db   1.832 [kilobytes] 2021-06-08 15:11:58
    ## 44        septic.sep    hru_parm_db   4.644 [kilobytes] 2021-06-08 15:11:58
    ## 45          snow.sno    hru_parm_db   0.326 [kilobytes] 2021-06-08 15:12:10
    ## 46          harv.ops            ops   1.273 [kilobytes] 2021-06-08 15:11:56
    ## 47         graze.ops            ops   1.626 [kilobytes] 2021-06-08 15:11:56
    ## 48           irr.ops            ops   0.662 [kilobytes] 2021-06-08 15:11:57
    ## 49      chem_app.ops            ops   1.897 [kilobytes] 2021-06-08 15:11:55
    ## 50          fire.ops            ops   0.265 [kilobytes] 2021-06-08 15:11:56
    ## 51         sweep.ops            ops   0.170 [kilobytes] 2021-06-08 15:11:58
    ## 52       landuse.lum            lum   1.613 [kilobytes] 2021-06-08 15:11:57
    ## 53       cntable.lum            lum  11.089 [kilobytes] 2021-06-08 15:11:55
    ## 54 cons_practice.lum            lum   3.243 [kilobytes] 2021-06-08 15:11:55
    ## 55     ovn_table.lum            lum   1.755 [kilobytes] 2021-06-08 15:11:58
    ## 56     cal_parms.cal            chg  15.543 [kilobytes] 2021-06-08 15:11:55
    ## 57         plant.ini           init   1.151 [kilobytes] 2021-06-08 15:11:58
    ## 58    soil_plant.ini           init   0.316 [kilobytes] 2021-06-08 15:11:58
    ## 59      om_water.ini           init   0.638 [kilobytes] 2021-06-08 15:11:58
    ## 60         soils.sol          soils  41.053 [kilobytes] 2021-06-08 15:11:58
    ## 61     nutrients.sol          soils   0.426 [kilobytes] 2021-06-08 15:11:58
    ## 62           lum.dtl decision_table  23.015 [kilobytes] 2021-06-08 15:11:58
    ## 63       res_rel.dtl decision_table 317.488 [kilobytes] 2021-06-08 15:11:58
    ## 64       scen_lu.dtl decision_table   9.514 [kilobytes] 2021-06-08 15:11:58
    ## 65       flo_con.dtl decision_table  10.361 [kilobytes] 2021-06-08 15:11:56
    ## 66       ls_unit.ele        regions   5.063 [kilobytes] 2021-06-08 15:11:58
    ## 67       ls_unit.def        regions   3.333 [kilobytes] 2021-06-08 15:11:57
    ## 68   aqu_catunit.ele        regions   5.165 [kilobytes] 2021-06-08 15:11:55

restore the backup that was created after running the previous demo
script

``` r
# restore model backup, which has Hargreaves-Samani PET method activated
print(demobak.dir)
```

    ## [1] "D:/UYRW_data/data/demo/demo_big_c_nr_emigrant_txtinout/backup_harg"

``` r
fout = rswat_copy(from=demobak.dir, fname='.', overwrite=TRUE, quiet=TRUE)
```

shorten the time series to show three complete winter baseflow periods

``` r
# set up dates for the first 1300 days
dates.demo = seq.Date(min(gage$date), min(gage$date) + 1300, by='day')
usgs.demo = gage %>% filter(date %in% dates.demo) %>% pull(flow)
rswat_time(dates.demo)
```

    ##        start          end 
    ## "1973-09-01" "1977-03-24"

modify the snow fall/melt parameters to align runoff peaks for the demo

``` r
# copy a simulation hydrograph with (mostly) default parameters
flo.orig = rswat_flo(gage %>% filter(date %in% dates.demo), restore=FALSE)
```

    ## SWAT+ configured for period 1973-09-01 to 1977-03-24 with output file sdc_1_tot.ohg 
    ## running SWAT+... 
    ## >> finished (4.79 seconds runtime) 
    ## parsing 82 SWAT+ output files...

``` r
# tune the SWAT+ snowmelt model for demo, using parameters fitted to this catchment elsewhere
snow.fit = data.frame(fall_tmp=4.91, melt_tmp=2, melt_max=8.79, melt_min=0.05, tmp_lag=0.25, snow_h2o=525)
snow.sno = rswat_open('snow.sno', quiet=TRUE)
snow.sno %>% modifyList(snow.fit) %>% rswat_write(preview=FALSE, quiet=TRUE)

# copy a simulation hydrograph with tuned snow parameters
flo.snow = rswat_flo(gage %>% filter(date %in% dates.demo), restore=FALSE)
```

    ## SWAT+ configured for period 1973-09-01 to 1977-03-24 with output file sdc_1_tot.ohg 
    ## running SWAT+... 
    ## >> finished (5.09 seconds runtime)

``` r
# make a plot showing these initial hydrographs
ggp.initial = gage %>% filter(date %in% dates.demo) %>% rename('USGS gage' = flow) %>%
  mutate('SWAT+ defaults' = flo.orig$flo %>% set_units(m^3/s)) %>%
  mutate('SWAT+ with snow tuned' = flo.snow$flo %>% set_units(m^3/s)) %>%
  my_tsplot(alph=0.7, ysqrt=TRUE, colors=c('black', 'brown2', 'forestgreen'))

# save to disk unless the file exists already
png.initial = here(baseflow.meta['initial', 'file'])
if( !file.exists(png.initial) ) ggsave(png.initial, 
                                       ggp.initial, 
                                       width=plot.w, 
                                       height=plot.h, 
                                       units='in')
```

![](https://raw.githubusercontent.com/deankoch/UYRW_data/master/graphics/demo_baseflow/initial_big_c_nr_emigrant.png)

These adjusted snow parameters help with the timing of the spring melt,
but the baseflow portion of the year is not satisfactory. The rest of
this script looks at ways of changing the SWAT+ aquifer model, and their
impacts on baseflow.

## the SWAT+ process model for baseflow

The pathway for baseflow in this model starts with precipitation -
either rain or melting snow - entering the soil. This water moves
downward towards the aquifer one soil layer at a time, charging each
layer with moisture before continuing its descent.

This creates a delay, as soil layers become drainable in SWAT+ only when
they reach a threshold water content. Excess water is then allowed to
percolate to the next layer. The threshold is controlled by scaling
parameter ‘perco’ (unitless, in 0 to 1):

``` r
rswat_docs('perco', fname='hydrology.hyd')
```

    ## 1 exact result(s) for "perco" in 1 file(s)
    ## 
    ## ~~~ hydrology.hyd : perco ~~~
    ## Percolation coefficient - adjusts soil moisture for perc to occur
    ## (1.0 = fc)

    ##    name          file pstart                                                     description
    ## 1 perco hydrology.hyd    126 Percolation coefficient - adjusts soil moisture for perc to ...

The model behind ‘perco’ involves three parameters from the
STATSGO/SSURGO database, characterizing soil water storage (see Section
2:3.1 of the [SWAT theory
guide](https://swat.tamu.edu/media/99192/swat2009-theory.pdf)):

``` r
rswat_docs('awc|bd|clay', fname='soils.sol', descw=0)
```

    ## 3 exact result(s) for "awc|bd|clay" in 1 file(s)

    ##   name      file pstart                                                     description
    ## 1   bd soils.sol    221 Moist bulk density (Mg/m3 or g/cm3). The soil bulk density e...
    ## 2  awc soils.sol    221 Available water capacity of the soil layer (mm H2O/mm soil)....
    ## 3 clay soils.sol    222 Clay content (% soil weight). The percent of soil particles ...

Note that percolation only occurs when a soil layer is thawed, and much
of the water moving through soil layers is diverted to either
evaporation, root uptake, or lateral flow. Influential parameters for
these processes include: ‘esco’, a shape parameter for a nonlinear soil
evaporation curve (a function of depth and PET); and the hydraulic
conductivity in the soil, ‘k’:

``` r
rswat_docs('esco', descw=0)
```

    ## 1 exact result(s) for "esco" in 1 file(s)
    ## 
    ## ~~~ hydrology.hyd : esco ~~~
    ## Soil evaporation compensation factor.
    ## This coefficient has been incorporated to allow the user to modify
    ## the depth distribution used to meet the soil evaporative demand to
    ## account for the effect of capillary action, crusting and cracks.
    ## ESCO must be between 0.01 and 1.0. As the value for ESCO is
    ## reduced, the model is able to extract more of the evaporative
    ## demand from lower levels.
    ## The change in depth distribution resulting from different values of
    ## esco are graphed in Figure 19-1.
    ## If no value for ESCO is entered, the model will set ESCO = 0.95.
    ## The value for ESCO may be set at the watershed or HRU level
    ## (ESCO in .bsn, see Chapter 4).
    ## Required.

    ##   name          file pstart                                                     description
    ## 1 esco hydrology.hyd    124 Soil evaporation compensation factor. This coefficient has b...

``` r
rswat_docs('k', fname='soils.sol', fuzzy=-1, descw=0)
```

    ## 1 exact result(s) for "k" in 1 file(s)
    ## 
    ## ~~~ soils.sol : k ~~~
    ## Saturated hydraulic conductivity (mm/hr).
    ## The saturated hydraulic conductivity, Ksat, relates soil
    ## water flow rate (flux density) to the hydraulic gradient and
    ## is a measure of the ease of water movement through the
    ## soil. Ksat is the reciprocal of the resistance of the soil
    ## matrix to water flow.

    ##   name      file pstart                                                     description
    ## 1    k soils.sol    221 Saturated hydraulic conductivity (mm/hr). The saturated hydr...

The aquifer sits between the bottom soil layer and an impervious layer
below, whose depth is set by the parameter ‘dep\_bot’ (m). For
catchments with aquifers, the deepest soil depth should be our minimum
depth for this impervious layer parameter and their difference defines
the volume of the aquifer and overlying vadose zone.

``` r
rswat_docs('dep_bot', fname='aquifer.aqu')
```

    ## 1 exact result(s) for "dep_bot" in 1 file(s)
    ## 
    ## ~~~ aquifer.aqu : dep_bot ~~~
    ## Depth to the bottom - mid-slope surface to bottom of aquifer (m)

    ##      name        file pstart                                                     description
    ## 1 dep_bot aquifer.aqu    118 Depth to the bottom - mid-slope surface to bottom of aquifer...

``` r
# find the minimum aquifer depth based on the soil profile depth
aqudep.min = rswat_open('soils.sol', quiet=TRUE) %>% pull(dp_tot) %>% max(na.rm=TRUE) %>% set_units(mm)
```

If we set ‘dep\_bot’ higher than `aqudep.min`, we get the SWAT+
representation of a perched aquifer; ie. ‘dep\_bot’ replaces ‘DEP\_IMP’
in previous versions of SWAT (see p235 of the SWAT2012 IO docs and
section 2:3.4 of the [SWAT theory
guide](https://swat.tamu.edu/media/99192/swat2009-theory.pdf)).

‘dep\_bot’ is currently set to 10 metres for all but the last row (the
deep aquifer)

``` r
rswat_open('aquifer.aqu', quiet=TRUE) %>% pull(dep_bot) %>% unique
```

    ## [1]  10 100

``` r
rswat_open('aquifer.aqu') %>% tail
```

    ##    id        name     init gw_flo dep_bot dep_wt no3_n sol_p carbon flo_dist bf_max alpha_bf revap rchg_dp
    ## 46 46      aqu232 initaqu1   0.05      10      3     0     0    0.5       50      1     0.05  0.02    0.05
    ## 47 47      aqu241 initaqu1   0.05      10      3     0     0    0.5       50      1     0.05  0.02    0.05
    ## 48 48      aqu242 initaqu1   0.05      10      3     0     0    0.5       50      1     0.05  0.02    0.05
    ## 49 49      aqu251 initaqu1   0.05      10      3     0     0    0.5       50      1     0.05  0.02    0.05
    ## 50 50      aqu252 initaqu1   0.05      10      3     0     0    0.5       50      1     0.05  0.02    0.05
    ## 51 51 aqu_deep006 initaqu1   0.00     100     20     0     0    0.5       50      1     0.01  0.00    0.00
    ##    spec_yld hl_no3n flo_min revap_min
    ## 46     0.05       0       3         5
    ## 47     0.05       0       3         5
    ## 48     0.05       0       3         5
    ## 49     0.05       0       3         5
    ## 50     0.05       0       3         5
    ## 51     0.03       0       0         0

``` r
n.aqu = rswat_open('aquifer.aqu') %>% nrow
print(n.aqu)
```

    ## [1] 51

There are 50 HRUs in this example, with one aquifer defined for each.
The deep aquifer is represented by an additional row in `aquifer.aqu`. A
model for the deep aquifer is described in the SWAT2012 theory guide,
however it does not appear to be supported by SWAT+ at this time, so we
can leave the deep aquifer fields at their defaults.

Percolation exiting the deepest soil profile layer can drain into the
aquifer very slowly. It feeds into a daily recharge equation (2:4.2.2)
in which a portion is always reserved for the next time step. This
introduces a delay, controlled by parameter `alpha_bf` (1/d), the
reciprocal of the “drainage time” (in days) of the aquifer, as described
in Sangrey, Harrop-Williams, & Klaiber ([1984, J Geot
Eng](https://ascelibrary.org/doi/abs/10.1061/\(ASCE\)0733-9410\(1984\)110:7\(957\)))

``` r
rswat_docs('alpha_bf', fname='aquifer.aqu')
```

    ## 1 exact result(s) for "alpha_bf" in 1 file(s)
    ## 
    ## ~~~ aquifer.aqu : alpha_bf ~~~
    ## Baseflow alpha factor (1/days).
    ## The baseflow recession constant, agw, is a direct index of
    ## groundwater flow response to changes in recharge (Smedema and
    ## Rycroft, 1983). Values vary from 0.1-0.3 for land with slow
    ## response to recharge to 0.9-1.0 for land with a rapid response.
    ## Although the baseflow recession constant may be calculated, the
    ## best estimates are obtained by analyzing measured streamflow
    ## during periods of no recharge in the watershed.
    ## It is common to find the baseflow days reported for a stream gage
    ## or watershed. This is the number of days for base flow recession to
    ## decline through one log cycle. When baseflow days are known, the
    ## alpha factor can be calculated:
    ##         1    <U+F8EE>Q         <U+F8F9>  1              2.3
    ## a gw = · ln <U+F8EF> gw, N <U+F8FA> =       · ln[10] =
    ##         N    <U+F8EF><U+F8F0> Q gw,0 <U+F8FA><U+F8FB> BFD            BFD
    ## 
    ## where agw is the baseflow recession constant, and BFD is the
    ## number of baseflow days for the watershed.
    ## Required.

    ##       name        file pstart                                                     description
    ## 1 alpha_bf aquifer.aqu    119 Baseflow alpha factor (1/days). The baseflow recession const...

## demonstration of aquifer parameter ranges in SWAT+

The section includes many examples of parameter modifications. We have a
shortcut function `rswat_amod` for making such changes on disk, and for
querying the current parameter value. eg. below, we define the R
function `dep_bot` to read/write the SWAT+ parameter ‘dep\_bot’ for all
HRUs (but not the deep aquifer):

``` r
# query the 'dep_bot' parameter via a shortcut function
dep_bot = rswat_find('dep_bot') %>% mutate(i=-n.aqu) %>% rswat_amod
dep_bot()
```

    ##   value    name   class dim        file table j   i
    ## 1    10 dep_bot numeric  51 aquifer.aqu     1 5 -51

The function returned by `rswat_amod` can be passed to `rswat_pexec` to
compare the simulations for a range of parameter values. eg. we can test
a sequence of different values of ‘alpha\_bf’ ranging from a day (the
default) to a year, like this:

``` r
# define the shortcut function and test values
alpha_bf = rswat_find('alpha_bf') %>% mutate(i=-51) %>% rswat_amod
alpha_bf.x = 1 / seq(1, 365, length=36)
print(alpha_bf.x)
```

    ##  [1] 1.000000000 0.087719298 0.045871560 0.031055901 0.023474178 0.018867925 0.015772871 0.013550136 0.011876485
    ## [10] 0.010570825 0.009523810 0.008665511 0.007949126 0.007342144 0.006821282 0.006369427 0.005973716 0.005624297
    ## [19] 0.005313496 0.005035247 0.004784689 0.004557885 0.004351610 0.004163197 0.003990423 0.003831418 0.003684598
    ## [28] 0.003548616 0.003422313 0.003304693 0.003194888 0.003092146 0.002995806 0.002905288 0.002820079 0.002739726

``` r
# set up a cluster to run simulations in parallel (copies SWAT+ folder)
rswat_cluster()
```

    ## 
    ## initializing new cluster...
    ## copying SWAT+ files to 8 nodes...

    ## $cl
    ## socket cluster with 8 nodes on host 'localhost'
    ## 
    ## $path
    ## [1] "D:/UYRW_data/data/demo/demo_big_c_nr_emigrant_txtinout/.rswat_cluster/node_1"
    ## [2] "D:/UYRW_data/data/demo/demo_big_c_nr_emigrant_txtinout/.rswat_cluster/node_2"
    ## [3] "D:/UYRW_data/data/demo/demo_big_c_nr_emigrant_txtinout/.rswat_cluster/node_3"
    ## [4] "D:/UYRW_data/data/demo/demo_big_c_nr_emigrant_txtinout/.rswat_cluster/node_4"
    ## [5] "D:/UYRW_data/data/demo/demo_big_c_nr_emigrant_txtinout/.rswat_cluster/node_5"
    ## [6] "D:/UYRW_data/data/demo/demo_big_c_nr_emigrant_txtinout/.rswat_cluster/node_6"
    ## [7] "D:/UYRW_data/data/demo/demo_big_c_nr_emigrant_txtinout/.rswat_cluster/node_7"
    ## [8] "D:/UYRW_data/data/demo/demo_big_c_nr_emigrant_txtinout/.rswat_cluster/node_8"

``` r
# run SWAT+ simulations for each test value (in parallel, wipe=FALSE keeps cluster files)
alpha_bf.out = rswat_pexec(alpha_bf.x, alpha_bf, dates=dates.demo, wipe=FALSE) 
```

    ## backing up config files... SWAT+ configured for period 1973-09-01 to 1977-03-24 with output file sdc_1_tot.ohg 
    ## backing up parameters... writing 36 parameter sets to disk...
    ## running SWAT+ in parallel...appending dates and units...
    ## restoring parameters...restoring file.cio, time.sim, print.prt, object.prt ...
    ## SWAT+ runtime: 45.33 seconds
    ## rswat runtime: 52 seconds

``` r
# plot the result on square root scale and overlay the USGS gage data
alpha_bf.nm = paste('SWAT+ simulations of 1/alpha_bf', 'aquifer drain time (days)', sep='\n')
ggp.alpha_bf = my_tsplot(alpha_bf.out, ysqrt=TRUE, legsc=1/alpha_bf.x, legnm=alpha_bf.nm, yunit='m^3/s') +
  geom_line(aes_(y=sqrt(drop_units(usgs.demo))), alpha=0.8)

# save to disk unless the file exists already
png.alpha_bf = here(baseflow.meta['alpha_bf', 'file'])
if( !file.exists(png.alpha_bf) ) ggsave(png.alpha_bf, 
                                        ggp.alpha_bf, 
                                        width=plot.w, 
                                        height=plot.h, 
                                        units='in')
```

![](https://raw.githubusercontent.com/deankoch/UYRW_data/master/graphics/demo_baseflow/alpha_bf_big_c_nr_emigrant.png)
The delay parameter has the effect of shifting the spring runoff peak
forward in time - by approximately 1/‘alpha\_bf’ days - and smoothing it
out over a longer period of slower groundwater flow. The spring
discharge becomes less flashy, except in the early days where (I think)
frozen soil is preventing recharge.

Note that the SWAT theory guide describes this delay model using
parameter “delta\_gw” (greek letter delta), and this notation is also
used in the SWAT2012 IO docs description of parameter “GW\_DELAY”. In
SWAT+, it has been replaced by (the reciprocal) ‘alpha\_bf’. For some
reason the SWAT2012 IO document lists both “GW\_DELAY” and “ALPHA\_BF”,
though from the descriptions they appear to be the same parameter with
different units.

For demonstration purposes we will set this much lower than the default
(longer delay) while tweaking other aquifer parameters. This will
exaggerate their effects so they can be seen more clearly. Note that in
many cases a parameter will appear to have no effect until it is
activated by another.

``` r
# set 'alpha_bf' to a delay of 100 days for demonstration purposes
alpha_bf(1/100)
```

    ##   value     name   class dim        file table  j   i
    ## 1  0.01 alpha_bf numeric  51 aquifer.aqu     1 12 -51

## initial values

When a long time series is available to warm up (ie equilibrate) the
model, the initial data for the aquifer is not particularly important.
See this note from the SWAT+ developers in the ‘aquifer.aqu’ file:

``` r
rswat_docs('flo', descw=0, fuzzy=-1, fname='aquifer.aqu')
```

    ## 1 exact result(s) for "flo" in 1 file(s)
    ## 
    ## ~~~ aquifer.aqu : flo ~~~
    ## Initial depth of water in the shallow aquifer (mm H2O).
    ## 
    ## We recommend using a 1 year equilibration period for the model
    ## where the watershed simulation is set to start 1 year prior to the
    ## period of interest. This allows the model to get the water cycling
    ## properly before any comparisons between measured and simulated
    ## data are made. When an equilibration period is incorporated, the
    ## value for FLO is not that important.

    ##   name        file pstart                                                     description
    ## 1  flo aquifer.aqu    118 Initial depth of water in the shallow aquifer (mm H2O). We r...

However, when learning the model, initial value parameters are quite
handy because they can be used to set the aquifer to known state that is
easily reproduced. Note that the part of the documentation queried above
(“flo”) is wrong - The initial value for shallow aquifer depth is called
‘dep\_wt’ in SWAT+. This is the initial depth to the water table (m)

``` r
# print the docs entry for this parameter
rswat_docs('dep_wt')
```

    ## 1 exact result(s) for "dep_wt" in 1 file(s)
    ## 
    ## ~~~ aquifer.aqu : dep_wt ~~~
    ## Depth – mid-slope surface to water water table (initial) (m).

    ##     name        file pstart                                                     description
    ## 1 dep_wt aquifer.aqu    118 Depth – mid-slope surface to water water table (initial) (m)...

``` r
# set up a demonstration over its range (making sure units match!)
dep_bot.current = set_units(dep_bot()$value, m)
dep_wt.x = seq(aqudep.min, dep_bot.current, length=36) %>% set_units(m) %>% drop_units()
dep_wt = rswat_find('dep_wt') %>% mutate(i=-51) %>% rswat_amod
```

We set the maximum here to be equal to the aquifer depth. Maximum
‘dep\_wt’ (10m, in this example) corresponds to no water in the
aquifer. The minimum (\~1.5m) is set to the bottom of the soil profile,
corresponding to maximal water storage.

``` r
# run the simulations and plot the results
dep_wt.out = rswat_pexec(dep_wt.x, dep_wt, dates=dates.demo, wipe=FALSE) 
```

    ## backing up config files... SWAT+ configured for period 1973-09-01 to 1977-03-24 with output file sdc_1_tot.ohg 
    ## backing up parameters... writing 36 parameter sets to disk...
    ## running SWAT+ in parallel...appending dates and units...
    ## restoring parameters...restoring file.cio, time.sim, print.prt, object.prt ...
    ## SWAT+ runtime: 45.78 seconds
    ## rswat runtime: 51.14 seconds

``` r
dep_wt.legnm = paste('SWAT+ simulations of dep_wt', 'depth to the water table (m)', sep='\n')
ggp.dep_wt = my_tsplot(dep_wt.out, ysqrt=TRUE, legsc=dep_wt.x, legnm=dep_wt.legnm, yunit='m^3/s') +
  geom_line(aes_(y=sqrt(drop_units(usgs.demo))), alpha=0.8)

# save to disk unless the file exists already
png.dep_wt = here(baseflow.meta['dep_wt', 'file'])
if( !file.exists(png.dep_wt) ) ggsave(png.dep_wt, 
                                      ggp.dep_wt, 
                                      width=plot.w, 
                                      height=plot.h, 
                                      units='in')
```

![](https://raw.githubusercontent.com/deankoch/UYRW_data/master/graphics/demo_baseflow/dep_wt_big_c_nr_emigrant.png)
The outputs respond as expected - more water initially produces higher
groundwater flow at a delay of 1/‘alpha\_bf’. As the simulation
progresses, this initial data has a diminishing impact, because the
system is equilibrating to its natural recharge/discharge cycle.

We will start the simulations below with a full aquifer, to emphasize
groundwater contributions to discharge:

``` r
# set 'dep_wt' to the bottom of the soil profile to initialize a full aquifer 
aqudep.min %>% set_units(m) %>% drop_units %>% dep_wt
```

    ##   value   name   class dim        file table j   i
    ## 1  1.52 dep_wt numeric  51 aquifer.aqu     1 6 -51

The other major initial data parameter for the aquifer is ‘gw\_flow’
(mm/day), the initial groundwater flow from the shallow aquifer. This is
not listed in the documentation, although it’s there in the
‘aquifer.aqu’ file where “flo” should be (see above). We can guess
its definition from a similarly-named parameter in the “lite” version of
SWAT+, with the following query:

``` r
# look for clues about a undefined parameter 'gw_flo':
rswat_docs('gw_flo')
```

    ## No exact matches for "gw_flo". Repeating search at fuzzy level 1 
    ## 1 approximate result(s) for "gw_flo" in 1 file(s)
    ## 
    ## ~~~ hru-lte.hru : gwflow ~~~
    ## Initial shallow aquifer flow (mm)

    ##     name        file pstart                       description
    ## 1 gwflow hru-lte.hru     87 Initial shallow aquifer flow (mm)

The parameters for SWAT+ lite are stored in the file ‘hru-lte.hru’. This
file isn’t used by the (non-“lite”) SWAT+ executable, but I’m finding
its parameter definitions are more up-to-date at this time, and
therefore helpful for resolving documentation gaps.

We will increase ‘gw\_flo’ from its default (1mm) to 10mm, to emphasize
initial groundwater contributions to discharge

``` r
gw_flo = rswat_find('gw_flo') %>% mutate(i=-51) %>% rswat_amod
gw_flo()
```

    ##   value   name   class dim        file table j   i
    ## 1  0.05 gw_flo numeric  51 aquifer.aqu     1 4 -51

``` r
gw_flo(5)
```

    ##   value   name   class dim        file table j   i
    ## 1     5 gw_flo numeric  51 aquifer.aqu     1 4 -51

## baseflow/recharge rate parameters

Note that ‘gw\_flo’ has no effect on the model unless ‘dep\_wt’ (initial
water table) is high enough to permit groundwater flow on the initial
day. In SWAT+, groundwater flows into channels only when the aquifer
water storage is above a certain threshold, set by parameter ‘flo\_min’
(m):

``` r
rswat_docs('flo_min')
```

    ## 1 exact result(s) for "flo_min" in 1 file(s)
    ## 
    ## ~~~ aquifer.aqu : flo_min ~~~
    ## Minimum aquifer storage to allow return flow [m]

    ##      name        file pstart                                      description
    ## 1 flo_min aquifer.aqu    120 Minimum aquifer storage to allow return flow [m]

From the description, one might get the impression that ‘flow\_min’ is
the depth from the bottom of the aquifer to the water table. However I
think it’s actually the depth from the mid-slope surface to the water
table (ie. the water table depth), based on the following:

``` r
# Vary threshold water storage (m) in the shallow aquifer to allow return flow:
flo_min = rswat_find('flo_min') %>% mutate(i=-51) %>% rswat_amod
flo_min.x = seq(0, drop_units(dep_bot.current), length=36)
flo_min.out = rswat_pexec(flo_min.x, flo_min, dates=dates.demo, wipe=FALSE) 
```

    ## backing up config files... SWAT+ configured for period 1973-09-01 to 1977-03-24 with output file sdc_1_tot.ohg 
    ## backing up parameters... writing 36 parameter sets to disk...
    ## running SWAT+ in parallel...appending dates and units...
    ## restoring parameters...restoring file.cio, time.sim, print.prt, object.prt ...
    ## SWAT+ runtime: 45.28 seconds
    ## rswat runtime: 51.35 seconds

``` r
# make the hydrograph plot object
flo_min.legnm = paste('SWAT+ simulations of flow_min', 'return flow threshold (m)', sep='\n')
ggp.dflo_min = my_tsplot(flo_min.out, ysqrt=TRUE, legsc=flo_min.x, legnm=flo_min.legnm, yunit='m^3/s') +
  geom_line(aes_(y=sqrt(drop_units(usgs.demo))), alpha=0.8)

# save to disk unless the file exists already
png.flo_min = here(baseflow.meta['flo_min', 'file'])
if( !file.exists(png.flo_min) ) ggsave(png.flo_min, 
                                       ggp.dflo_min, 
                                       width=plot.w, 
                                       height=plot.h, 
                                       units='in')
```

![](https://raw.githubusercontent.com/deankoch/UYRW_data/master/graphics/demo_baseflow/flo_min_big_c_nr_emigrant.png)
Recall that the simulation is initialized with a full aquifer and a
fairly high groundwater flow rate. This high baseflow continues until
the aquifer is drained to its threshold storage level ‘flow\_min’, at
which point the flow rate rapidly drops off. This happens at different
times during the winter of 1974 for different HRUs, so the drop-off is
staggered.

We can see that the first curves to drop off are the ones with the
lowest ‘flow\_min’ values, meaning low ‘flow\_min’ actually corresponds
to a high aquifer storage threshold. This is reasonable if we interpret
‘flow\_min’ as a depth to the water table.

To ensure that we get baseflow, we should therefore set ‘flo\_min’ near
to (or above) its physical maximum of ‘dep\_bot’. We do this now to
encourage baseflow happens wherever possible for the rest of the
demonstration

``` r
# set 'flo_min' so that baseflow happens whenever the aquifer is not dry
flo_min(dep_bot.current)
```

    ##    value    name   class dim        file table  j   i
    ## 1 10 [m] flo_min numeric  51 aquifer.aqu     1 17 -51

The deep aquifer percolation fraction, ‘rchg\_dp’ (fraction from 0 to 1)
controls the proportion of percolation that drains to the deep aquifer.
This water is effectively lost from the model, as SWAT+ does not
currently model any processes that can return this flow to channels (or
overlying layers). Here it simply serves to scale down our estimates of
aquifer storage:

``` r
rswat_docs('rchg_dp')
```

    ## 1 exact result(s) for "rchg_dp" in 1 file(s)
    ## 
    ## ~~~ aquifer.aqu : rchg_dp ~~~
    ## Deep aquifer percolation fraction.
    ## 
    ## The fraction of percolation from the root zone which recharges the
    ## deep aquifer. The value for RCHRG_DP should be between 0.0
    ## and 1.0.
    ## Required.

    ##      name        file pstart                                                     description
    ## 1 rchg_dp aquifer.aqu    120 Deep aquifer percolation fraction. The fraction of percolati...

``` r
# a demonstration of its range
rchg_dp = rswat_find('rchg_dp') %>% mutate(i=-51) %>% rswat_amod
rchg_dp.x = seq(0, 1, length=36)
rchg_dp.out = rswat_pexec(rchg_dp.x, rchg_dp, dates=dates.demo, wipe=FALSE) 
```

    ## backing up config files... SWAT+ configured for period 1973-09-01 to 1977-03-24 with output file sdc_1_tot.ohg 
    ## backing up parameters... writing 36 parameter sets to disk...
    ## running SWAT+ in parallel...appending dates and units...
    ## restoring parameters...restoring file.cio, time.sim, print.prt, object.prt ...
    ## SWAT+ runtime: 45.29 seconds
    ## rswat runtime: 49.74 seconds

``` r
# make the hydrograph plot object
rchg_dp.legnm = paste('SWAT+ simulations of rchg_dp', 'deep aquifer recharge fraction', sep='\n')
ggp.rchg_dp = my_tsplot(rchg_dp.out, ysqrt=TRUE, legsc=rchg_dp.x, legnm=rchg_dp.legnm, yunit='m^3/s') +
  geom_line(aes_(y=sqrt(drop_units(usgs.demo))), alpha=0.8)

# save to disk unless the file exists already
png.rchg_dp = here(baseflow.meta['rchg_dp', 'file'])
if( !file.exists(png.rchg_dp) ) ggsave(png.rchg_dp, 
                                       ggp.rchg_dp, 
                                       width=plot.w, 
                                       height=plot.h, 
                                       units='in')
```

![](https://raw.githubusercontent.com/deankoch/UYRW_data/master/graphics/demo_baseflow/rchg_dp_big_c_nr_emigrant.png)
Some of the water that would otherwise drain to the aquifer and become
baseflow ends up getting pulled back upwards through the unsaturated
zone via evaporation or root uptake, a process called “revap” in the
SWAT+ model. This happens at a rate equal to the product of the
potential evapotranspiration (PET) for the day and the revap
coefficient, parameter ‘revap’ (a fraction between 0 and 1):

``` r
# look up the documentation
rswat_docs('revap', fname='aquifer.aqu', fuzzy=-1, descw=0)
```

    ## 1 exact result(s) for "revap" in 1 file(s)
    ## 
    ## ~~~ aquifer.aqu : revap ~~~
    ## Groundwater "revap" coefficient.
    ## Water may move from the shallow aquifer into the overlying
    ## unsaturated zone. In periods when the material overlying the
    ## aquifer is dry, water in the capillary fringe that separates the
    ## saturated and unsaturated zones will evaporate and diffuse upward.
    ## As water is removed from the capillary fringe by evaporation, it is
    ## replaced by water from the underlying aquifer. Water may also be
    ## removed from the aquifer by deep-rooted plants which are able to
    ## uptake water directly from the aquifer.
    ## This process is significant in watersheds where the saturated zone
    ## is not very far below the surface or where deep-rooted plants are
    ## growing. Because the type of plant cover will affect the importance
    ## of revap in the water balance, the parameters governing revap can
    ## be varied by land use.
    ## As REVAP approaches 0, movement of water from the shallow
    ## aquifer to the root zone is restricted. As REVAP approaches 1, the
    ## rate of transfer from the shallow aquifer to the root zone
    ## approaches the rate of potential evapotranspiration. The value for
    ## REVAP should be between 0.02 and 0.20.
    ## This variable, along with REVAPMN, is the reason a different
    ## groundwater file is created for each HRU rather than each
    ## subbasin.
    ## Required.

    ##    name        file pstart                                                     description
    ## 1 revap aquifer.aqu    119 Groundwater "revap" coefficient. Water may move from the sha...

``` r
# make a shortcut modification function and check current value
revap = rswat_find('revap') %>% mutate(i=-51) %>% rswat_amod
revap()
```

    ##   value  name   class dim        file table  j   i
    ## 1  0.02 revap numeric  51 aquifer.aqu     1 13 -51

This is currently set very low but if we simulate through its range the
effect on baseflow becomes clear

``` r
revap = rswat_find('revap') %>% mutate(i=-51) %>% rswat_amod
revap.x = seq(0, 1, length=36)
revap.out = rswat_pexec(revap.x, revap, dates=dates.demo, wipe=FALSE) 
```

    ## backing up config files... SWAT+ configured for period 1973-09-01 to 1977-03-24 with output file sdc_1_tot.ohg 
    ## backing up parameters... writing 36 parameter sets to disk...
    ## running SWAT+ in parallel...appending dates and units...
    ## restoring parameters...restoring file.cio, time.sim, print.prt, object.prt ...
    ## SWAT+ runtime: 46.62 seconds
    ## rswat runtime: 52.19 seconds

``` r
# make the hydrograph plot object
revap.legnm = paste('SWAT+ simulations of revap', 'percolation fraction', sep='\n')
ggp.revap = my_tsplot(revap.out, ysqrt=TRUE, legsc=revap.x, legnm=revap.legnm, yunit='m^3/s') +
  geom_line(aes_(y=sqrt(drop_units(usgs.demo))), alpha=0.8)

# save to disk unless the file exists already
png.revap = here(baseflow.meta['revap', 'file'])
if( !file.exists(png.revap) ) ggsave(png.revap, 
                                     ggp.revap, 
                                     width=plot.w, 
                                     height=plot.h, 
                                     units='in')
```

![](https://raw.githubusercontent.com/deankoch/UYRW_data/master/graphics/demo_baseflow/revap_big_c_nr_emigrant.png)
We increase it here to exaggerate the effect of the next parameter

``` r
revap(0.25)
```

    ##   value  name   class dim        file table  j   i
    ## 1  0.25 revap numeric  51 aquifer.aqu     1 13 -51

Like baseflow, revap only occurs when the aquifer storage lies above a
threshold. This is set by the ‘revap\_min’ parameter, the maximum water
table depth (m) required for revap:

``` r
rswat_docs('revap_min')
```

    ## 1 exact result(s) for "revap_min" in 1 file(s)
    ## 
    ## ~~~ aquifer.aqu : revap_min ~~~
    ## Threshold depth of water in the shallow aquifer for “revap” or
    ## percolation to the deep aquifer to occur (mm H2O).
    ## Movement of water from the shallow aquifer to the unsaturated
    ## zone is allowed only if the volume of water in the shallow aquifer
    ## is equal to or greater than REVAPMN.
    ## This variable, along with GW_REVAP, is the reason a different
    ## groundwater file is created for each HRU rather than each
    ## subbasin.
    ## Required.

    ##        name        file pstart                                                     description
    ## 1 revap_min aquifer.aqu    120 Threshold depth of water in the shallow aquifer for “revap” ...

Note the “to the deep aquifer” part must be a typo (unless I’m
misunderstanding something), as are the units reported in the
documentation (mm). Like the other parameters so far defined, this one
should be given in metres; and like ‘flo\_min’, it refers to depth to
the water table:

``` r
# a demonstration of the range of 'revap_min'
revap_min = rswat_find('revap_min') %>% mutate(i=-51) %>% rswat_amod
revap_min.x = seq(0, drop_units(dep_bot.current), length=36)
revap_min.out = rswat_pexec(revap_min.x, revap_min, dates=dates.demo, wipe=FALSE) 
```

    ## backing up config files... SWAT+ configured for period 1973-09-01 to 1977-03-24 with output file sdc_1_tot.ohg 
    ## backing up parameters... writing 36 parameter sets to disk...
    ## running SWAT+ in parallel...appending dates and units...
    ## restoring parameters...restoring file.cio, time.sim, print.prt, object.prt ...
    ## SWAT+ runtime: 48.16 seconds
    ## rswat runtime: 54.83 seconds

``` r
# make the hydrograph plot object
revap_min.legnm = paste('SWAT+ simulations of revap_min', 'revap threshold (m)', sep='\n')
ggp.revap_min = my_tsplot(revap_min.out, ysqrt=TRUE, legsc=revap_min.x, legnm=revap_min.legnm, yunit='m^3/s') +
  geom_line(aes_(y=sqrt(drop_units(usgs.demo))), alpha=0.8)

# save to disk unless the file exists already
png.revap_min = here(baseflow.meta['revap_min', 'file'])
if( !file.exists(png.revap_min) ) ggsave(png.revap_min, 
                                         ggp.revap_min, 
                                         width=plot.w, 
                                         height=plot.h, 
                                         units='in')
```

![](https://raw.githubusercontent.com/deankoch/UYRW_data/master/graphics/demo_baseflow/revap_min_big_c_nr_emigrant.png)

## wrapping up

We’re finished with simulations so we can shut down the cluster and
delete its files

``` r
rswat_cluster(wipe=T)
```

    ## shutting down workers and cleaning up...done

The following parameters in ‘aquifer.aqu’ also relate to baseflow rates,
but they appear to be inactive. They should therefore be omitted from
fitting routines so as not to impede/confuse the optimizer:

``` r
# a baseflow rate parameter (to fine-tune rate of groundwater flow into channels?)
rswat_docs('bf_max')
```

    ## 1 exact result(s) for "bf_max" in 1 file(s)
    ## 
    ## ~~~ aquifer.aqu : bf_max ~~~
    ## Baseflow rate when the entire area is contributing to baseflow
    ## (mm) default = 1.00

    ##     name        file pstart                                                     description
    ## 1 bf_max aquifer.aqu    118 Baseflow rate when the entire area is contributing to basefl...

``` r
# a mean distance to channel parameter (to moderate lateral flow?)
rswat_docs('flo_dist')
```

    ## 1 exact result(s) for "flo_dist" in 1 file(s)
    ## 
    ## ~~~ aquifer.aqu : flo_dist ~~~
    ## FLO_DIST default =50.0
    ## Optional.

    ##       name        file pstart                       description
    ## 1 flo_dist aquifer.aqu    118 FLO_DIST default =50.0 Optional.

``` r
# specific yield of the shallow aquifer (to determine groundwater height?)
rswat_docs('spec_yld')
```

    ## 1 exact result(s) for "spec_yld" in 1 file(s)
    ## 
    ## ~~~ aquifer.aqu : spec_yld ~~~
    ## Specific yield of the shallow aquifer (m3/m3).
    ## Specific yield is defined as the ratio of the volume of water that drains by
    ## 
    ## gravity to the total volume of rock.
    ## 
    ## 
    ## Specific yield is required to calculate groundwater height
    ## fluctuations.
    ## This variable is not active

    ##       name        file pstart                                                     description
    ## 1 spec_yld aquifer.aqu    120 Specific yield of the shallow aquifer (m3/m3). Specific yiel...

Finally, note that we have ignored several sediment-related variables
(‘sol\_p’, ‘carbon’, etc) for simplicity. For now we are only
concerned with hydrograph matching of discharge rates, but we will
revisit sediment later on.

## conclusions

To summarize, baseflow in SWAT+ is controlled by the ‘aquifer.aqu’
config file, and is sensitive to the following parameters:

  - ‘dep\_bot’ (m), the depth to the aquifer bottom
  - ‘flo\_min’ (m), the water table depth above which groundwater flow
    occurs
  - ‘revap\_min’ (m), the water table depth above which revap occurs
  - ‘revap’ (fraction), scaling constant for revap rate
  - ‘rchg\_dp’ (fraction), the proportion of percolation flow lost to
    the deep aquifer
  - ‘alpha\_bf’ (1/days), the aquifer drainage time

where ‘flo\_min’ and ‘revap\_min’ should lie between ‘dep\_bot’ and the
bottom of the deepest soil profile layer. Values closer to ‘dep\_bot’
cause the aquifer to drain more often.

Initial data are supplied by:

  - ‘dep\_wt’ (m), the initial water table depth
  - ‘gw\_flo’ (mm), the initial groundwater flow rate

And the parameters ‘bf\_max’, ‘flo\_dist’, ‘spec\_yld’ can be left at
their default value until they are activated by the SWAT+ developers.
